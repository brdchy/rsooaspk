# РСОО "АСПК" - Веб-сайт

Полнофункциональный веб-сайт для РСОО "АСПК" с админ-панелью для управления контентом и интеграцией с VK.

## Технологии

- **Next.js 14** - React фреймворк с App Router
- **TypeScript** - Типизация
- **Prisma** - ORM для работы с базой данных
- **SQLite** - База данных (можно легко переключиться на PostgreSQL)
- **Tailwind CSS** - Стилизация
- **bcryptjs** - Хеширование паролей
- **VK API** - Интеграция для импорта новостей из группы VK

## Установка и запуск

### Локальная разработка (без Docker)

1. Установите зависимости:
```bash
npm install
```

2. Создайте файл `.env` в корне проекта:
```
DATABASE_URL="file:./dev.db"
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-secret-key-change-in-production"
VK_ACCESS_TOKEN="your-vk-access-token"  # Для синхронизации с VK (опционально)
```

3. Инициализируйте базу данных:
```bash
npm run db:push
```

4. Заполните базу данных начальными данными:
```bash
npm run db:seed
```

5. Запустите сервер разработки:
```bash
npm run dev
```

Откройте [http://localhost:3000](http://localhost:3000) в браузере.

### Быстрый запуск с Docker (для продакшна)

**Важно:** При использовании Docker шаги 3-4 (инициализация БД) **не нужны** - они выполняются автоматически при первом запуске контейнера.

1. Создайте файл `.env`:
```env
DATABASE_URL="file:./data/prisma.db"
NODE_ENV=production
PORT=3000
HOSTNAME=0.0.0.0
NEXTAUTH_SECRET="your-strong-secret-key-here"
NEXTAUTH_URL="https://rsooaspk.ru"
```

2. Запустите Docker Compose:
```bash
docker-compose up -d --build
```

База данных автоматически создастся и заполнится начальными данными при первом запуске.

## Доступ к админ-панели

- URL: `/admin` или `/account/login`
- Email: `admin@rsooaspk.ru`
- Пароль: `admin123`

**ВНИМАНИЕ:** Измените пароль администратора после первого входа!

## Интеграция с VK

### Работа без токена

Система работает без необходимости получения VK Access Token. Используется публичный API и парсинг HTML страницы группы.

**Примечание:** Для публичных групп это работает без ограничений. Если публичный API недоступен, система автоматически использует парсинг HTML.

### Миграция существующих постов

Импортировать все существующие посты из группы VK:
```bash
npm run vk:migrate
```

Или с ограничением количества:
```bash
tsx scripts/migrate-vk-posts.ts --limit=50
```

### Демон для автоматической синхронизации

Запустить демона, который будет периодически проверять новые посты:
```bash
npm run vk:sync
```

Или с настройкой интервала (в миллисекундах, по умолчанию 1 час = 3600000):
```bash
tsx scripts/vk-sync-daemon.ts --interval=1800000
```

### Ручная синхронизация через админ-панель

В админ-панели на странице новостей есть кнопка "Синхронизировать с VK", которая проверяет последние 20 постов и импортирует новые.

### API endpoint для синхронизации

Можно вызвать API endpoint для синхронизации:
```bash
POST /api/admin/vk/sync
```

## Структура проекта

```
├── app/                    # Next.js App Router
│   ├── admin/             # Админ-панель
│   ├── api/               # API роуты
│   │   └── admin/
│   │       └── vk/        # VK синхронизация
│   ├── account/           # Личный кабинет
│   ├── federation/        # Раздел Федерация
│   ├── about-sport/       # Раздел О спорте
│   ├── events/            # Раздел Мероприятия
│   ├── news/              # Раздел Новости
│   ├── refereeing/        # Раздел Судейство
│   ├── documents/         # Раздел Документы
│   ├── regions/           # Раздел Регионы
│   └── page.tsx           # Главная страница
├── components/            # React компоненты
│   └── admin/             # Компоненты админ-панели
├── lib/                   # Утилиты и библиотеки
│   └── vk-api.ts          # Утилиты для работы с VK API
├── scripts/               # Скрипты
│   ├── migrate-vk-posts.ts  # Миграция постов из VK
│   └── vk-sync-daemon.ts    # Демон синхронизации
├── prisma/                # Схема базы данных и сиды
└── public/                # Статические файлы
```

## Функционал

### Публичная часть

- Главная страница с новостями и мероприятиями
- Раздел "Федерация" (Президент, Президиум, История, Контакты)
- Раздел "О спорте" (История, Правила, Стать спортсменом, Антидопинг, О страйкболе)
- Раздел "Мероприятия" (Календарь, План, Положения, Протоколы)
- Раздел "Новости" с детальными страницами
- Раздел "Судейство" (Положения, Требования, Правила, Реестр, Обучение)
- Раздел "Документы" (по категориям)
- Раздел "Филиалы" со списком всех филиалов
- Личный кабинет (регистрация и вход)

### Админ-панель

- Управление новостями (создание, редактирование, публикация)
- Управление мероприятиями
- Управление документами
- Управление страницами контента
- Управление регионами
- Просмотр пользователей
- Синхронизация новостей с VK

## База данных

Схема базы данных включает:
- **User** - Пользователи (администраторы и обычные пользователи)
- **Region** - Филиалы организации
- **News** - Новости (с поддержкой VK постов)
- **Event** - Мероприятия
- **Document** - Документы
- **Page** - Страницы контента

## Производственная настройка

### Развертывание с Docker (рекомендуется)

1. **Создайте файл `.env` на сервере:**
```env
DATABASE_URL="file:./data/prisma.db"
NODE_ENV=production
PORT=3000
HOSTNAME=0.0.0.0
NEXTAUTH_SECRET="your-strong-secret-key-here"
NEXTAUTH_URL="https://rsooaspk.ru"
```

2. **Запустите с Docker Compose:**
```bash
docker-compose up -d --build
```

Приложение будет доступно на порту 3000. База данных автоматически инициализируется при первом запуске.

### Развертывание без Docker

1. Измените `NEXTAUTH_SECRET` на случайную строку
2. Переключитесь на PostgreSQL (измените `DATABASE_URL` в `.env`) - рекомендуется для продакшна
3. Установите переменные окружения на хостинге
4. Настройте `VK_ACCESS_TOKEN` для автоматической синхронизации
5. Запустите миграции: `npm run db:push`
6. Запустите сборку: `npm run build`
7. Запустите сервер: `npm start` (слушает на 0.0.0.0:3000)

### Подробная документация

См. [DEPLOY.md](./DEPLOY.md) для подробных инструкций по развертыванию, настройке Nginx, SSL, резервному копированию и решению проблем.

### Автоматическая синхронизация с VK

Для автоматической синхронизации в продакшене можно использовать:
- systemd service (Linux)
- PM2 с cron (Node.js)
- GitHub Actions или другие CI/CD
- Планировщик задач вашего хостинга
- Cron в Docker контейнере

## Лицензия

Все права защищены © 2025 РСОО "АСПК"
